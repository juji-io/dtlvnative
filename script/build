#!/bin/bash

set -eou pipefail

export SOEXT=.so

# build usearch

cd src/usearch

# Use x86-64-v3 (AVX2) baseline for portable binaries on x86_64
ARCH_FLAGS=""
if [ "$(uname -m)" = "x86_64" ]; then
    ARCH_FLAGS="-march=x86-64-v3"
fi

cmake \
    -D CMAKE_BUILD_TYPE=Release \
    ${ARCH_FLAGS:+-D CMAKE_CXX_FLAGS="$ARCH_FLAGS"} \
    ${ARCH_FLAGS:+-D CMAKE_C_FLAGS="$ARCH_FLAGS"} \
    -D USEARCH_USE_FP16LIB=1 \
    -D USEARCH_USE_OPENMP=1 \
    -D USEARCH_USE_SIMSIMD=1 \
    -D USEARCH_BUILD_TEST_CPP=1 \
    -D USEARCH_BUILD_TEST_C=1 \
    -D USEARCH_BUILD_LIB_C=1 \
    -B build_release

cmake --build build_release --config Release

build_release/test_cpp
build_release/test_c

# build lmdb and dtlv

export LDFLAGS="${LDFLAGS:+$LDFLAGS }-static-libstdc++ -static-libgcc -Wl,-rpath,'$$ORIGIN'"
export OMP_LIB="-fopenmp"
export USEARCH_LIB="-Wl,--whole-archive -lusearch -Wl,--no-whole-archive"

cd ..
make clean
make

# Bundle libgomp/libomp so users do not need system packages
GCC_BIN="${CC:-gcc}"
LIBGOMP_SO="$($GCC_BIN -print-file-name=libgomp.so.1)"
if [ -f "${LIBGOMP_SO}" ]; then
    cp "${LIBGOMP_SO}" libgomp.so.1
    cp "${LIBGOMP_SO}" libgomp.so
fi
