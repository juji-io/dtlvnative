#!/bin/bash

set -eou pipefail

export SOEXT=.dylib

## build usearch

cd src/usearch

# Use LLVM clang with OpenMP. Allow overrides so CI can preinstall toolchains without Homebrew.
LLVM_PREFIX="${LLVM_PREFIX:-}"
LIBOMP_PREFIX="${LIBOMP_PREFIX:-}"
if [ -z "${LLVM_PREFIX}" ] && command -v brew >/dev/null 2>&1; then
  LLVM_PREFIX="$(brew --prefix llvm 2>/dev/null || true)"
fi
if [ -z "${LIBOMP_PREFIX}" ] && command -v brew >/dev/null 2>&1; then
  LIBOMP_PREFIX="$(brew --prefix libomp 2>/dev/null || true)"
fi

# Fallbacks for common Homebrew prefixes
LLVM_PREFIX="${LLVM_PREFIX:-/opt/homebrew/opt/llvm}"
LIBOMP_PREFIX="${LIBOMP_PREFIX:-/opt/homebrew/opt/libomp}"

if [ ! -x "${LLVM_PREFIX}/bin/clang" ]; then
  echo "clang with OpenMP not found; set LLVM_PREFIX to a toolchain that provides it." >&2
  exit 1
fi

export PATH="${LLVM_PREFIX}/bin:$PATH"
export LDFLAGS="${LDFLAGS:+$LDFLAGS }-L${LLVM_PREFIX}/lib -L${LIBOMP_PREFIX}/lib -L/opt/homebrew/opt/llvm/lib -L/opt/homebrew/opt/libomp/lib -L/usr/local/opt/llvm/lib -L/usr/local/opt/libomp/lib"
export CPPFLAGS="${CPPFLAGS:+$CPPFLAGS }-I${LLVM_PREFIX}/include -I${LIBOMP_PREFIX}/include -I/opt/homebrew/opt/llvm/include -I/opt/homebrew/opt/libomp/include -I/usr/local/opt/llvm/include -I/usr/local/opt/libomp/include"

# Get macOS SDK path for Homebrew LLVM
SDKROOT="$(xcrun --show-sdk-path)"

cmake \
    -D CMAKE_OSX_SYSROOT="${SDKROOT}" \
    -D CMAKE_BUILD_TYPE=Release \
    -D CMAKE_C_COMPILER="$(brew --prefix llvm)/bin/clang" \
    -D CMAKE_CXX_COMPILER="$(brew --prefix llvm)/bin/clang++" \
    -D USEARCH_USE_FP16LIB=1 \
    -D USEARCH_USE_OPENMP=1 \
    -D USEARCH_USE_SIMSIMD=1 \
    -D USEARCH_BUILD_TEST_CPP=1 \
    -D USEARCH_BUILD_TEST_C=1 \
    -D USEARCH_BUILD_LIB_C=1 \
    -B build_release

cmake --build build_release --config Release

build_release/test_cpp
build_release/test_c

## build lmdb and dtlv

export OMP_LIB="-lomp"
export USEARCH_LIB="-Wl,-force_load,libusearch.a"

cd ..
make clean
make

# Bundle libomp so end users do not need Homebrew
LIBOMP_DYLIB="${LIBOMP_PREFIX}/lib/libomp.dylib"
CURRENT_LIBOMP_PATH="$(otool -L libdtlv.dylib | awk '/libomp/{print $1;exit}' || true)"
if [ -n "${CURRENT_LIBOMP_PATH}" ] && [ "${CURRENT_LIBOMP_PATH}" != "@loader_path/libomp.dylib" ]; then
    install_name_tool -change "${CURRENT_LIBOMP_PATH}" "@loader_path/libomp.dylib" libdtlv.dylib
fi
LIBOMP_SOURCE="${CURRENT_LIBOMP_PATH:-${LIBOMP_DYLIB}}"
if [ -f "${LIBOMP_SOURCE}" ]; then
    cp "${LIBOMP_SOURCE}" libomp.dylib
fi
